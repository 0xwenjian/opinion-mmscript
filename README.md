# Opinion 快速限价交易机器人

## 文件说明

- `trader.py` - 完整版交易机器人（带状态管理、风控）
- `fast_trader.py` - 极速简化版（最小延迟）
- `config.yaml` - 配置文件
- `start.bat` - Windows启动脚本

## 快速开始

### 1. 修改配置

编辑 `config.yaml`，设置 `topic_id`（从Opinion网站获取市场ID）

### 2. 运行

**方式一：使用配置文件**
```bash
python trader.py
```

**方式二：命令行参数（推荐快速交易）**
```bash
python fast_trader.py --topic 123 --buy 0.90 --sell 0.93 --amount 10
```

参数说明：
- `--topic/-t`: 市场ID（必填）
- `--buy/-b`: 买入价格，如0.90表示90%
- `--sell/-s`: 卖出价格，如0.93表示93%
- `--amount/-a`: 每次交易金额USD
- `--outcome/-o`: YES或NO（默认YES）
- `--interval/-i`: 循环间隔秒（默认0.5）

## 示例

```bash
# 90买入 93卖出 每次10美元
python fast_trader.py -t 12345 -b 0.90 -s 0.93 -a 10

# 更激进的策略
python fast_trader.py -t 12345 -b 0.88 -s 0.92 -a 20 -i 0.3
```

按 `Ctrl+C` 停止运行。

---

## Solo Market 单市场做市脚本

### 功能说明

`solomarket.py` 是一个专门为单个市场提供流动性的做市脚本，核心目标是**提供流动性而非成交**。

**核心特点**：
- ✅ 每个市场只维护一个买单
- ✅ 智能保护机制：确保订单前方有足够的保护金额
- ✅ 档位限制：首次下单限制在指定档位内
- ✅ 自动调整：当保护不足或档位超标时自动调整订单
- ✅ 买1特殊处理：永不直接挂买1价，避免成交风险

### 配置说明

在 `config.yaml` 中配置 `solo_market` 部分：

```yaml
solo_market:
  topic_ids: [4306, 4307]           # 要监控的市场ID列表
  min_protection_amount: 100        # 最小前方保护金额（USD）
  order_amount: 30                  # 每次挂单金额（USD）
  check_bid_position: 10            # 首次下单的档位限制（最多挂在买10）
```

**参数详解**：
- `min_protection_amount`: 订单前方必须有的最小保护金额。例如设置为 $100，表示我们的订单前面至少要有 $100 的买单作为缓冲。
- `check_bid_position`: 首次下单时的档位限制。例如设置为 10，表示首次下单最多只能挂在买10档位，如果买1-10都不满足保护要求，则不下单。

### 运行方式

**正式模式**：
```bash
python3 solomarket.py
```

**模拟模式**（测试用）：
```bash
python3 solomarket.py --sim
```

### 核心逻辑

#### 1. 价格计算策略
- **买1满足保护** → 挂单价格 = `买1价 - 0.001`
  - 实际会挂在买2档位，前方有整个买1作为保护
- **买2及以下满足保护** → 挂单价格 = `该档位价格`
  - 直接匹配该档位，利用前方累计保护

#### 2. 订单调整触发条件

**触发器 A：保护不足（全局扫描）**
- 当前订单前方保护金额 < `min_protection_amount`
- 行为：扫描整个订单簿（不限档位），找到任何安全位置

**触发器 B：档位超标（范围内补位）**
- 当前订单档位 > `check_bid_position`
- 行为：在 [1, check_bid_position] 范围内寻找最佳安全位置

#### 3. 举例说明

假设配置：`min_protection = 500`, `check_bid_position = 5`

**场景1：首次下单**
```
订单簿：
买1: 0.3520 @ $800
买2: 0.3510 @ $400
买3: 0.3500 @ $300
```
- 买1累计保护 $800 >= $500 ✓
- 触发买1特殊逻辑
- **挂单：0.3510（买2档位）**
- 前方保护：$800

**场景2：档位超标触发补位**
```
当前挂单：0.3460（买6档位）
订单簿变化后：买6 > 5（超出限制）
```
- 触发档位超标
- 扫描买1-5，找到买1满足保护
- **撤单并重新挂单：0.3510（买2档位）**

### 日志说明

脚本会记录以下关键信息：
- ✅ `[挂单成功]` - 成功下单
- ⚠️ `[非预期成交]` - 订单被成交（包含价格、金额、时长）
- 🔄 `触发调整(保护不足)` - 因保护不足调整订单
- 🔄 `触发调整(档位超标)` - 因档位超标调整订单

### 注意事项

1. **首次下单限制**：`check_bid_position` 仅用于首次下单，后续调整可能超出此限制（为了保命）
2. **成交风险**：虽然有保护机制，但极端市场波动仍可能导致成交
3. **监控建议**：定期检查日志文件，关注 `[非预期成交]` 记录
4. **参数调整**：根据市场深度调整 `min_protection_amount`，流动性好的市场可以设置更高的保护金额

---
